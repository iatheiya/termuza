name: termuza-deep-scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  BUILD_TOOLS_VERSION: '34.0.0'
  JAVA_VERSION: '17'
  AVD_NAME: 'ci_avd'
  API_LEVEL: '34'
  EMU_BOOT_TIMEOUT_SEC: '600'
  ANDROID_ARCH: 'x86_64'
  ANDROID_TARGET: 'google_apis'

jobs:
  diagnostics:
    name: diagnostics
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - run: chmod +x ./gradlew
      - name: unit-tests-debug
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics-${RUNID}-unit-debug.txt"
          ./gradlew testDebugUnitTest --stacktrace --info --no-daemon 2>&1 | tee "$OUT" || true
      - name: unit-tests-release
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics-${RUNID}-unit-release.txt"
          ./gradlew testReleaseUnitTest --stacktrace --info --no-daemon 2>&1 | tee "$OUT" || true
      - name: lint-check
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics-${RUNID}-lint.txt"
          ./gradlew lint --stacktrace --info --no-daemon 2>&1 | tee "$OUT" || true
      - name: collect-diagnostics-logs
        if: always()
        run: |
          RUNID=${{ github.run_id }}
          mkdir -p diagnostics_out
          mv diagnostics-*.txt diagnostics_out/ 2>/dev/null || true
          if [ -d "app/build/reports" ]; then cp -r app/build/reports diagnostics_out/reports; fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagnostics-data
          path: diagnostics_out

  build:
    name: build
    runs-on: ubuntu-latest
    needs: diagnostics
    if: always()
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
      - run: chmod +x ./gradlew
      - name: prepare-keystore
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.keystore
          else
            keytool -genkeypair -v -keystore release.keystore -alias ci_release -storepass android -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=CI, OU=CI, O=CI, L=CI, ST=CI, C=US"
          fi
      - name: assemble-release
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="build-${RUNID}-assemble.txt"
          ./gradlew clean assembleRelease --stacktrace --info --no-daemon 2>&1 | tee "$OUT" || true
      - name: find-apk
        id: find_apk
        run: |
          APK="$(find app/build/outputs/apk -type f -name "*.apk" ! -name "*-unaligned.apk" | head -n 1 || true)"
          if [ -n "$APK" ]; then
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_ENV
          else
            echo "apk_exists=false" >> $GITHUB_ENV
          fi
      - name: analyze-native-libs
        if: env.apk_exists == 'true'
        run: |
          APK="${{ steps.find_apk.outputs.apk_path }}"
          unzip -l "$APK" | grep "lib/" > native_libs_structure.txt || echo "NO_NATIVE_LIBS" > native_libs_structure.txt
      - name: analyze-manifest
        if: always()
        run: |
          find app/build -name "AndroidManifest.xml" -print0 | xargs -0 grep -E "exported|permission|activity" > manifest_analysis.txt || true
      - name: collect-build-logs
        if: always()
        run: |
          mkdir -p build_out
          mv build-*.txt build_out/ 2>/dev/null || true
          mv native_libs_structure.txt build_out/ 2>/dev/null || true
          mv manifest_analysis.txt build_out/ 2>/dev/null || true
          find app/build/outputs/apk -name "*.apk" -exec cp {} build_out/ \; 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-data
          path: build_out

  emulator:
    name: emulator
    runs-on: ubuntu-latest
    needs: build
    if: always()
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
      - uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
      - name: install-emulator-images
        run: |
          echo "y" | sdkmanager --licenses
          sdkmanager "platform-tools" "emulator" "system-images;android-${{ env.API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}"
      - uses: actions/download-artifact@v4
        with:
          name: build-data
          path: downloaded_apk
      - name: identify-apk
        id: find_apk
        run: |
          APK="$(find downloaded_apk -type f -name "*.apk" | head -n 1 || true)"
          if [ -n "$APK" ]; then
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_ENV
          else
            echo "apk_exists=false" >> $GITHUB_ENV
          fi
      - name: create-avd
        if: env.apk_exists == 'true'
        run: |
          echo "no" | avdmanager create avd -n "${AVD_NAME}" -k "system-images;android-${{ env.API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}" --force
      - name: run-emulator-test
        if: env.apk_exists == 'true'
        continue-on-error: true
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          APK="${{ steps.find_apk.outputs.apk_path }}"
          LOGDIR="emulator_logs"
          mkdir -p "$LOGDIR"
          
          emulator -avd "${AVD_NAME}" -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -no-snapshot > "$LOGDIR/emu_stdout.txt" 2> "$LOGDIR/emu_stderr.txt" &
          EMU_PID=$!
          
          echo "Waiting for emulator boot..."
          START_TIME=$(date +%s)
          BOOT_COMPLETED=0
          while [ $(( $(date +%s) - START_TIME )) -lt ${{ env.EMU_BOOT_TIMEOUT_SEC }} ]; do
            STATUS=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$STATUS" = "1" ]; then
              BOOT_COMPLETED=1
              break
            fi
            sleep 5
          done
          
          if [ "$BOOT_COMPLETED" -eq 0 ]; then
             echo "TIMEOUT_BOOT" > "$LOGDIR/boot_failure.txt"
             adb logcat -d > "$LOGDIR/logcat_boot_fail.txt" 2>&1
             kill -9 $EMU_PID
             exit 0
          fi
          
          adb devices -l > "$LOGDIR/devices.txt"
          adb install -r "$APK" > "$LOGDIR/install.txt" 2>&1
          
          BUILD_TOOLS=$(ls -d $ANDROID_HOME/build-tools/*/ | tail -n 1)
          AAPT="$BUILD_TOOLS/aapt"
          PKG=$($AAPT dump badging "$APK" | grep "package: name=" | awk -F"'" '{print $2}')
          ACT=$($AAPT dump badging "$APK" | grep "launchable-activity: name=" | awk -F"'" '{print $2}')
          
          echo "PKG=$PKG" > "$LOGDIR/pkg_info.txt"
          echo "ACT=$ACT" >> "$LOGDIR/pkg_info.txt"
          
          adb logcat -c
          
          if [ -n "$PKG" ] && [ -n "$ACT" ]; then
            adb shell am start -n "$PKG/$ACT"
            sleep 20
          elif [ -n "$PKG" ]; then
            adb shell monkey -p "$PKG" -c android.intent.category.LAUNCHER 1
            sleep 20
          else
            echo "CANNOT_DETERMINE_LAUNCH" > "$LOGDIR/launch_error.txt"
          fi
          
          adb logcat -d > "$LOGDIR/full_logcat.txt"
          adb shell dumpsys package "$PKG" > "$LOGDIR/dumpsys.txt" 2>/dev/null || true
          
          grep -E "FATAL|AndroidRuntime|Exception|Caused by|ANR" "$LOGDIR/full_logcat.txt" > "$LOGDIR/runtime_crashes.txt" || true
          
          adb emu kill || kill -9 $EMU_PID
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: emulator-data
          path: emulator_logs

  report:
    name: final-report
    runs-on: ubuntu-latest
    needs: [diagnostics, build, emulator]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
      - name: generate-strict-report
        run: |
          OUT="FULL_STRICT_REPORT.txt"
          touch "$OUT"
          echo "=== DEEP SCAN REPORT ===" >> "$OUT"
          echo "Generated at: $(date)" >> "$OUT"
          echo "========================" >> "$OUT"
          
          echo "" >> "$OUT"
          echo "[SECTION 1: RUNTIME CRASHES]" >> "$OUT"
          find artifacts -name "runtime_crashes.txt" -type f -exec cat {} + >> "$OUT" || echo "No runtime crashes detected or log missing." >> "$OUT"
          
          echo "" >> "$OUT"
          echo "[SECTION 2: BUILD FAILURES]" >> "$OUT"
          find artifacts -name "build-*-assemble.txt" -type f -exec grep -E "FAILURE|FAILED|Error" {} + >> "$OUT" || true
          
          echo "" >> "$OUT"
          echo "[SECTION 3: UNIT TEST FAILURES]" >> "$OUT"
          find artifacts -name "diagnostics-*-unit-*.txt" -type f -exec grep -E "FAILED|FAILURE" {} + >> "$OUT" || true
          
          echo "" >> "$OUT"
          echo "[SECTION 4: LINT ISSUES]" >> "$OUT"
          find artifacts -name "diagnostics-*-lint.txt" -type f -exec grep -E "Error|Warning" {} + | head -n 100 >> "$OUT" || true
          
          echo "" >> "$OUT"
          echo "[SECTION 5: NATIVE LIB ANALYSIS]" >> "$OUT"
          find artifacts -name "native_libs_structure.txt" -type f -exec cat {} + >> "$OUT" || true
          
          echo "" >> "$OUT"
          echo "[SECTION 6: MANIFEST ANALYSIS]" >> "$OUT"
          find artifacts -name "manifest_analysis.txt" -type f -exec cat {} + >> "$OUT" || true

          echo "" >> "$OUT"
          echo "[SECTION 7: DETAILED LOGS HEADERS]" >> "$OUT"
          find artifacts -name "*.txt" -print0 | xargs -0 grep -H -E "FATAL|Exception" | head -n 200 >> "$OUT" || true
          
      - uses: actions/upload-artifact@v4
        with:
          name: FINAL_REPORT
          path: FULL_STRICT_REPORT.txt
