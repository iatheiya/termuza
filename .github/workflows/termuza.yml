name: termuza

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'
  API_LEVEL: '30'
  ANDROID_TARGET: 'aosp_atd'
  ANDROID_ARCH: 'x86_64'
  AVD_NAME: 'ci_optimized'
  EMU_BOOT_TIMEOUT_SEC: '900'
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx3072m -XX:+UseParallelGC"
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'

jobs:
  diagnostics:
    name: diagnostics
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - run: chmod +x ./gradlew
      - name: check-kvm
        run: |
          if [ -r /dev/kvm ]; then
            echo "kvm_available=true" >> $GITHUB_ENV
          else
            echo "kvm_available=false" >> $GITHUB_ENV
          fi
          mkdir -p diagnostics_out
          cat /proc/cpuinfo > diagnostics_out/cpuinfo.txt 2>/dev/null || true
          lsmod | grep kvm > diagnostics_out/kvm_modules.txt 2>/dev/null || true
      - name: unit-tests-debug
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics_out/diagnostics-${RUNID}-unit-debug.txt"
          ./gradlew testDebugUnitTest --stacktrace 2>&1 | tee "$OUT" || true
      - name: lint-check
        continue-on-error: true
        run: |
          RUNID=${{ github.run_id }}
          OUT="diagnostics_out/diagnostics-${RUNID}-lint.txt"
          ./gradlew lint --stacktrace 2>&1 | tee "$OUT" || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagnostics-data
          path: diagnostics_out

  build:
    name: build
    runs-on: ubuntu-latest
    needs: diagnostics
    if: always()
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
      - run: chmod +x ./gradlew
      - name: prepare-keystore
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.keystore
          else
            keytool -genkeypair -v -keystore release.keystore -alias ci_release -storepass android -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=CI,OU=CI,O=CI,L=CI,ST=CI,C=US"
          fi
      - name: assemble-release
        continue-on-error: true
        run: |
          mkdir -p build_out
          RUNID=${{ github.run_id }}
          OUT="build_out/build-${RUNID}-assemble.txt"
          ./gradlew clean assembleRelease --stacktrace 2>&1 | tee "$OUT" || true
      - name: find-apk
        id: find_apk
        run: |
          APK="$(find app/build/outputs/apk -type f -name "*.apk" ! -name "*-unaligned.apk" | head -n 1 || true)"
          if [ -n "$APK" ]; then
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_ENV
          else
            echo "apk_exists=false" >> $GITHUB_ENV
          fi
      - name: analyze-artifacts
        if: env.apk_exists == 'true'
        run: |
          APK="${{ steps.find_apk.outputs.apk_path }}"
          unzip -l "$APK" | grep "lib/" > build_out/native_libs_structure.txt || echo "NO_NATIVE_LIBS" > build_out/native_libs_structure.txt
          find app/build -name "AndroidManifest.xml" -print0 | xargs -0 grep -E "exported|permission|activity" > build_out/manifest_analysis.txt || true
      - name: collect-apks
        if: always()
        run: |
          find app/build/outputs/apk -name "*.apk" -exec cp {} build_out/ \; 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-data
          path: build_out

  emulator:
    name: emulator
    runs-on: ubuntu-latest
    needs: build
    if: always()
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
      - uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
      - uses: actions/download-artifact@v4
        with:
          name: build-data
          path: downloaded_apk
      - name: identify-apk
        id: find_apk
        run: |
          APK="$(find downloaded_apk -type f -name "*.apk" | head -n 1 || true)"
          if [ -n "$APK" ]; then
            echo "apk_path=$APK" >> $GITHUB_OUTPUT
            echo "apk_exists=true" >> $GITHUB_ENV
          else
            echo "apk_exists=false" >> $GITHUB_ENV
          fi
      - name: setup-avd-optimized
        if: env.apk_exists == 'true'
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}"
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/$ANDROID_BUILD_TOOLS_VERSION:$PATH"
          mkdir -p "$ANDROID_HOME"
          mkdir -p "$HOME/.android/avd"
          yes | sdkmanager --sdk_root="$ANDROID_HOME" "platform-tools" "emulator" "build-tools;${{ env.ANDROID_BUILD_TOOLS_VERSION }}" "system-images;android-${{ env.API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}" || true
          yes | sdkmanager --sdk_root="$ANDROID_HOME" --licenses || true
          avdmanager create avd -n "${AVD_NAME}" -k "system-images;android-${{ env.API_LEVEL }};${{ env.ANDROID_TARGET }};${{ env.ANDROID_ARCH }}" --device "pixel" --force
          CONFIG_DIR="$HOME/.android/avd/${AVD_NAME}.avd"
          mkdir -p "$CONFIG_DIR"
          printf "hw.ramSize=2048\nvm.heapSize=512\nhw.lcd.density=160\nhw.lcd.height=800\nhw.lcd.width=480\nhw.accelerometer=no\nhw.audioInput=no\nhw.battery=no\nhw.gps=no\nhw.mainKeys=no\nhw.dPad=no\nhw.trackBall=no\nimage.sysdir.1=system-images/android-${{ env.API_LEVEL }}/${{ env.ANDROID_TARGET }}/${{ env.ANDROID_ARCH }}/\n" > "$CONFIG_DIR/config.ini"
      - name: run-emulator-and-test
        if: env.apk_exists == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          export ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}"
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/build-tools/$ANDROID_BUILD_TOOLS_VERSION:$PATH"
          APK="${{ steps.find_apk.outputs.apk_path }}"
          LOGDIR="emulator_logs"
          mkdir -p "$LOGDIR"
          
          ACCEL_FLAG="-accel off"
          if [ "${{ env.kvm_available }}" = "true" ] && [ -r /dev/kvm ]; then
            ACCEL_FLAG="-accel on"
            sudo chmod 666 /dev/kvm || true
          fi
          
          adb kill-server || true
          adb start-server || true
          (while true; do date; free -h; sleep 60; done) > "$LOGDIR/memory_monitor.txt" &
          
          EMU_STDOUT="$LOGDIR/emu_stdout.txt"
          EMU_STDERR="$LOGDIR/emu_stderr.txt"
          
          emulator -avd "${AVD_NAME}" -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect $ACCEL_FLAG -no-snapshot -no-snapshot-save -camera-back none -cache-size 1024 >"$EMU_STDOUT" 2>"$EMU_STDERR" &
          EMU_PID=$!
          
          START_TIME=$(date +%s)
          BOOT_SUCCESS=false
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$(( CURRENT_TIME - START_TIME ))
            if ! kill -0 $EMU_PID 2>/dev/null; then
              echo "PROCESS_DIED" > "$LOGDIR/boot_error.txt"
              break
            fi
            STATUS=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || true)
            if [ "$STATUS" = "1" ]; then
              BOOT_SUCCESS=true
              break
            fi
            if [ $ELAPSED -ge ${{ env.EMU_BOOT_TIMEOUT_SEC }} ]; then
              echo "TIMEOUT" > "$LOGDIR/boot_error.txt"
              break
            fi
            sleep 10
          done
          
          if [ "$BOOT_SUCCESS" = "true" ]; then
            sleep 15
            adb wait-for-device
            adb logcat -c || true
            if timeout 120s adb install -r "$APK" > "$LOGDIR/install_log.txt" 2>&1; then
              PKG=""
              ACT=""
              AAPT_PATH=$(find $ANDROID_HOME/build-tools -name "aapt" | sort -V | tail -n 1)
              if [ -x "$AAPT_PATH" ]; then
                PKG=$("$AAPT_PATH" dump badging "$APK" | grep "package: name=" | awk -F"'" '{print $2}' || true)
                ACT=$("$AAPT_PATH" dump badging "$APK" | grep "launchable-activity: name=" | awk -F"'" '{print $2}' || true)
              else
                PKG=$(unzip -p "$APK" AndroidManifest.xml 2>/dev/null | strings | head -n 1 || true)
              fi
              
              if [ -n "$PKG" ]; then
                if [ -n "$ACT" ]; then
                  adb shell am start -n "$PKG/$ACT" || true
                else
                  adb shell monkey -p "$PKG" 1 || true
                fi
                sleep 30
                adb logcat -d > "$LOGDIR/full_logcat.txt" || true
                grep -E "FATAL|AndroidRuntime|Exception|Caused by|ANR" "$LOGDIR/full_logcat.txt" > "$LOGDIR/runtime_crashes.txt" || echo "No crashes found" > "$LOGDIR/runtime_crashes.txt"
              else
                echo "PKG_ERROR" > "$LOGDIR/parse_error.txt"
              fi
            else
              echo "INSTALL_ERROR" > "$LOGDIR/install_error.txt"
            fi
            adb emu kill || kill -9 $EMU_PID 2>/dev/null || true
          else
            echo "BOOT_FAILURE" > "$LOGDIR/boot_failure_log.txt"
            cp "$EMU_STDERR" "$LOGDIR/boot_failure_stderr.txt" || true
            kill -9 $EMU_PID 2>/dev/null || true
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: emulator-data
          path: emulator_logs

  report:
    name: final-report
    runs-on: ubuntu-latest
    needs: [diagnostics, build, emulator]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts
      - name: generate-strict-report
        run: |
          OUT="FULL_STRICT_REPORT.txt"
          touch "$OUT"
          echo "=== STRICT CI REPORT ===" >> "$OUT"
          echo "Timestamp: $(date)" >> "$OUT"
          echo "Run ID: ${{ github.run_id }}" >> "$OUT"
          echo "========================" >> "$OUT"
          echo "" >> "$OUT"
          echo "[SECTION: CRITICAL FAILURES]" >> "$OUT"
          if find artifacts -name "boot_error.txt" -type f -exec grep -q "." {} \; ; then
             echo "CRITICAL: EMULATOR BOOT FAILED" >> "$OUT"
             find artifacts -name "boot_error.txt" -type f -exec cat {} + >> "$OUT"
          fi
          if find artifacts -name "install_error.txt" -type f -exec grep -q "." {} \; ; then
             echo "CRITICAL: APK INSTALLATION FAILED" >> "$OUT"
          fi
          if find artifacts -name "runtime_crashes.txt" -type f -exec grep -v "No crashes found" {} + | grep -q "." ; then
             echo "CRITICAL: RUNTIME CRASH DETECTED" >> "$OUT"
             find artifacts -name "runtime_crashes.txt" -type f -exec cat {} + >> "$OUT"
          else
             echo "No Runtime Crashes Detected." >> "$OUT"
          fi
          echo "" >> "$OUT"
          echo "[SECTION: BUILD & TEST ERRORS]" >> "$OUT"
          find artifacts -name "build-*-assemble.txt" -type f -exec grep -E "FAILURE|FAILED|Error:" {} + >> "$OUT" || true
          find artifacts -name "diagnostics-*-unit-*.txt" -type f -exec grep -E "FAILED|FAILURE" {} + >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: LINT ISSUES (Top 100)]" >> "$OUT"
          find artifacts -name "diagnostics-*-lint.txt" -type f -exec grep -E "Error|Warning" {} + | head -n 100 >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: APK STRUCTURE]" >> "$OUT"
          find artifacts -name "native_libs_structure.txt" -type f -exec cat {} + >> "$OUT" || true
          echo "" >> "$OUT"
          echo "[SECTION: EMULATOR DEBUG LOGS]" >> "$OUT"
          find artifacts -name "emu_stderr.txt" -type f -exec tail -n 50 {} + >> "$OUT" || true
          echo "[SECTION: MEMORY USAGE]" >> "$OUT"
          find artifacts -name "memory_monitor.txt" -type f -exec tail -n 10 {} + >> "$OUT" || true
      - uses: actions/upload-artifact@v4
        with:
          name: FINAL_REPORT
          path: FULL_STRICT_REPORT.txt
